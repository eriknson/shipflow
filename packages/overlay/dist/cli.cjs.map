{"version":3,"sources":["../src/cli.ts"],"sourcesContent":["#!/usr/bin/env node\n\nimport { spawnSync } from \"child_process\";\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from \"fs\";\nimport path from \"path\";\n\nconst HELP_TEXT = `shipflow-overlay <command>\n\nCommands:\n  init        Scaffold Shipflow overlay files into the current Next.js project.\n  help        Display this message.\n`;\n\nconst API_ROUTE_TEMPLATE = `import { createNextHandler } from \"@shipflow/overlay/next\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nconst handler = createNextHandler();\n\nexport const POST = handler;\n`;\n\nconst PROVIDER_TEMPLATE = `'use client';\n\nimport { FlowOverlayProvider } from \"@shipflow/overlay\";\n\nexport function ShipflowOverlay() {\n  return <FlowOverlayProvider />;\n}\n`;\n\nconst README_TEMPLATE = [\n  \"# Shipflow Overlay Setup\",\n  \"\",\n  \"1. Ensure `cursor-agent` is installed and available on your PATH. If you installed it elsewhere, set `CURSOR_AGENT_BIN` in your environment.\",\n  \"2. Import `ShipflowOverlay` from `app/shipflow-overlay-provider` and render it in `app/layout.tsx` (ideally inside `<body>`) gated to development mode.\",\n  \"3. Update `next.config.mjs` to wrap your config with `withShipflowOverlay` from `@shipflow/overlay/next`.\",\n  \"4. Restart `npm run dev`.\",\n].join(\"\\n\");\n\nfunction ensureDir(filePath: string) {\n  const dir = path.dirname(filePath);\n  if (!existsSync(dir)) {\n    mkdirSync(dir, { recursive: true });\n  }\n}\n\nfunction createFileIfMissing(filePath: string, content: string) {\n  if (existsSync(filePath)) {\n    return false;\n  }\n  ensureDir(filePath);\n  writeFileSync(filePath, content, \"utf8\");\n  return true;\n}\n\nfunction checkCursorAgent(): string | null {\n  const whichCommand = process.platform === \"win32\" ? \"where\" : \"which\";\n  const lookup = spawnSync(whichCommand, [\"cursor-agent\"], { encoding: \"utf8\" });\n  if (!lookup.error && lookup.status === 0 && lookup.stdout) {\n    const resolvedPath = lookup.stdout.split(/\\r?\\n/).find(Boolean);\n    if (resolvedPath) {\n      return resolvedPath.trim();\n    }\n  }\n  return null;\n}\n\nfunction appendEnvHint(filePath: string, binaryPath: string | null) {\n  const lines: string[] = [\n    \"# Cursor CLI binary path for Shipflow overlay\",\n    \"CURSOR_AGENT_BIN=\" + (binaryPath ?? \"\"),\n  ];\n  if (existsSync(filePath)) {\n    const current = readFileSync(filePath, \"utf8\");\n    if (current.includes(\"CURSOR_AGENT_BIN\")) {\n      return false;\n    }\n    const next = current.endsWith(\"\\n\") ? current : `${current}\\n`;\n    writeFileSync(filePath, `${next}${lines.join(\"\\n\")}\\n`, \"utf8\");\n    return true;\n  }\n  writeFileSync(filePath, `${lines.join(\"\\n\")}\\n`, \"utf8\");\n  return true;\n}\n\nasync function runInit() {\n  const cwd = process.cwd();\n  console.log(\"▶ Setting up Shipflow overlay in\", cwd);\n\n  const agentPath = checkCursorAgent();\n  if (!agentPath) {\n    console.warn(\n      \"⚠️  cursor-agent was not found on PATH. Install it via Cursor (https://cursor.sh) or set CURSOR_AGENT_BIN.\",\n    );\n  } else {\n    console.log(\"✓ cursor-agent located at\", agentPath);\n  }\n\n  const apiRouteCreated = createFileIfMissing(\n    path.join(cwd, \"app\", \"api\", \"shipflow\", \"overlay\", \"route.ts\"),\n    API_ROUTE_TEMPLATE,\n  );\n  console.log(\n    apiRouteCreated\n      ? \"✓ Created app/api/shipflow/overlay/route.ts\"\n      : \"• app/api/shipflow/overlay/route.ts already exists\",\n  );\n\n  const providerCreated = createFileIfMissing(\n    path.join(cwd, \"app\", \"shipflow-overlay-provider.tsx\"),\n    PROVIDER_TEMPLATE,\n  );\n  console.log(\n    providerCreated\n      ? \"✓ Created app/shipflow-overlay-provider.tsx\"\n      : \"• app/shipflow-overlay-provider.tsx already exists\",\n  );\n\n  const readmeCreated = createFileIfMissing(\n    path.join(cwd, \"SHIPFLOW_SETUP.md\"),\n    README_TEMPLATE,\n  );\n  console.log(readmeCreated ? \"✓ Added SHIPFLOW_SETUP.md\" : \"• SHIPFLOW_SETUP.md already exists\");\n\n  const envAppended = appendEnvHint(path.join(cwd, \".env.example\"), agentPath);\n  console.log(\n    envAppended\n      ? \"✓ Added CURSOR_AGENT_BIN hint to .env.example\"\n      : \"• .env.example already contains CURSOR_AGENT_BIN\",\n  );\n\n  console.log(\"\\nNext steps:\");\n  console.log(\"  1. Wrap your next.config with withShipflowOverlay from @shipflow/overlay/next.\");\n  console.log(\n    \"  2. Import ShipflowOverlay from app/shipflow-overlay-provider and render it inside app/layout.tsx (development only).\",\n  );\n  console.log(\"  3. Restart your dev server.\");\n}\n\nasync function main() {\n  const [, , command] = process.argv;\n\n  switch (command) {\n    case \"init\":\n      await runInit();\n      break;\n    case \"help\":\n    case \"--help\":\n    case \"-h\":\n    case undefined:\n      console.log(HELP_TEXT);\n      break;\n    default:\n      console.error(`Unknown command: ${command}`);\n      console.log(HELP_TEXT);\n      process.exitCode = 1;\n  }\n}\n\nvoid main();\n\n\n\n"],"mappings":"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","names":["path"]}