{"version":3,"sources":["../src/server/cursorAgent.ts"],"sourcesContent":["import { spawn, spawnSync } from \"child_process\";\nimport { access } from \"fs/promises\";\nimport { constants as fsConstants } from \"fs\";\nimport path from \"path\";\n\nimport type { StreamEvent } from \"../runtime/types\";\n\nconst LOG_PREFIX = \"[shipflow-overlay]\";\nconst CURSOR_BINARY_HINT = process.env.CURSOR_AGENT_BIN ?? \"cursor-agent\";\nconst HOME_DIR = process.env.HOME ?? process.env.USERPROFILE ?? \"\";\n\ntype ResolveOptions = {\n  binaryPath?: string;\n  additionalSearchDirs?: string[];\n  logPrefix?: string;\n};\n\ntype ResolvedBinary = {\n  binary: string;\n  env: NodeJS.ProcessEnv | null;\n};\n\ntype RunOptions = {\n  binary: string;\n  model: string;\n  prompt: string;\n  timeoutMs?: number;\n  logPrefix?: string;\n  env?: NodeJS.ProcessEnv | null;\n};\n\nlet cachedBinary: string | null = null;\nlet cachedEnv: NodeJS.ProcessEnv | null = null;\nlet resolvePromise: Promise<ResolvedBinary> | null = null;\n\nconst IGNORED_STATUS_MESSAGES = new Set([\"User event\"]);\n\nconst WHITELISTED_STATUS_MESSAGES = new Set([\n  \"Initializing agent\",\n  \"Agent ready.\",\n  \"Thinking\",\n  \"Building changes\",\n  \"Analyzing project\",\n  \"Build step complete.\",\n]);\n\nconst MIN_STATUS_LENGTH = 30;\nconst STATUS_KEYS = [\"text\", \"value\", \"delta\", \"message\", \"summary\", \"label\"];\n\nconst STREAM_HEADERS = {\n  \"Content-Type\": \"application/x-ndjson; charset=utf-8\",\n  \"Cache-Control\": \"no-cache, no-transform\",\n};\n\nexport { STREAM_HEADERS };\n\nconst pathExistsAndExecutable = async (filePath: string) => {\n  if (!filePath) return false;\n  try {\n    await access(filePath, fsConstants.X_OK);\n    return true;\n  } catch {\n    try {\n      await access(filePath, fsConstants.F_OK);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n};\n\nconst describeEvent = (event: unknown): string | null => {\n  if (!event || typeof event !== \"object\") {\n    return null;\n  }\n\n  const payload = event as Record<string, unknown>;\n  const type = typeof payload.type === \"string\" ? payload.type : null;\n  const subtype = typeof payload.subtype === \"string\" ? payload.subtype : null;\n\n  if (type === \"system\") {\n    if (subtype === \"init\") {\n      return \"Initializing agent\";\n    }\n    if (subtype === \"progress\" && typeof payload.message === \"string\") {\n      return payload.message;\n    }\n    if (subtype === \"completed\") {\n      return \"Agent ready.\";\n    }\n    return subtype ? `System update: ${subtype}` : \"System update.\";\n  }\n\n  if (type === \"assistant\") {\n    return \"Thinking…\";\n  }\n\n  if (type === \"tool_call\") {\n    const toolName =\n      typeof payload.tool === \"object\" &&\n      payload.tool &&\n      typeof (payload.tool as Record<string, unknown>).name === \"string\"\n        ? String((payload.tool as Record<string, unknown>).name)\n        : \"Tool\";\n    const normalizedName = toolName.toLowerCase();\n\n    if (subtype === \"started\") {\n      if (\n        normalizedName.includes(\"apply\") ||\n        normalizedName.includes(\"write\") ||\n        normalizedName.includes(\"patch\") ||\n        normalizedName.includes(\"build\")\n      ) {\n        return \"Building changes…\";\n      }\n      if (normalizedName.includes(\"plan\") || normalizedName.includes(\"analy\")) {\n        return \"Analyzing project…\";\n      }\n      return `Running ${toolName}…`;\n    }\n    if (subtype === \"completed\") {\n      if (\n        normalizedName.includes(\"apply\") ||\n        normalizedName.includes(\"write\") ||\n        normalizedName.includes(\"patch\") ||\n        normalizedName.includes(\"build\")\n      ) {\n        return \"Build step complete.\";\n      }\n      return `${toolName} finished.`;\n    }\n    return `${toolName} ${subtype ?? \"update\"}…`;\n  }\n\n  if (type === \"result\") {\n    return \"Finalizing changes…\";\n  }\n\n  if (type === \"error\") {\n    if (typeof payload.message === \"string\") {\n      return `Error: ${payload.message}`;\n    }\n    return \"Cursor CLI reported an error.\";\n  }\n\n  if (typeof payload.message === \"string\") {\n    return payload.message;\n  }\n\n  return type ? `Event: ${type}${subtype ? `/${subtype}` : \"\"}` : null;\n};\n\nconst extractAssistantText = (input: unknown, seen = new WeakSet<object>()): string => {\n  if (!input) return \"\";\n  if (typeof input === \"string\") {\n    return input;\n  }\n  if (Array.isArray(input)) {\n    return input.map((entry) => extractAssistantText(entry, seen)).join(\"\");\n  }\n  if (typeof input === \"object\") {\n    if (seen.has(input as object)) return \"\";\n    seen.add(input as object);\n\n    const record = input as Record<string, unknown>;\n    let text = \"\";\n\n    for (const key of STATUS_KEYS) {\n      const value = record[key];\n      if (typeof value === \"string\") {\n        text += value;\n      } else if (value) {\n        text += extractAssistantText(value, seen);\n      }\n    }\n\n    if (\"content\" in record) {\n      text += extractAssistantText(record.content, seen);\n    }\n    if (\"parts\" in record) {\n      text += extractAssistantText(record.parts, seen);\n    }\n    if (\"text_delta\" in record) {\n      text += extractAssistantText(record.text_delta, seen);\n    }\n\n    return text;\n  }\n  return \"\";\n};\n\nconst buildCandidateDirs = (binaryPath: string | undefined, additionalSearchDirs: string[]) => {\n  const candidateDirs = new Set<string>(\n    (process.env.PATH ?? \"\")\n      .split(path.delimiter)\n      .map((entry) => entry.trim())\n      .filter(Boolean),\n  );\n\n  for (const dir of additionalSearchDirs) {\n    if (dir) {\n      candidateDirs.add(dir);\n    }\n  }\n\n  if (HOME_DIR) {\n    candidateDirs.add(path.join(HOME_DIR, \".cursor\", \"bin\"));\n    candidateDirs.add(path.join(HOME_DIR, \"Library\", \"Application Support\", \"Cursor\", \"bin\"));\n    candidateDirs.add(path.join(HOME_DIR, \"AppData\", \"Local\", \"Programs\", \"cursor\", \"bin\"));\n  }\n\n  if (binaryPath && path.isAbsolute(binaryPath)) {\n    candidateDirs.add(path.dirname(binaryPath));\n  }\n\n  return Array.from(candidateDirs);\n};\n\nasync function discoverCursorAgentBinary(options: ResolveOptions): Promise<ResolvedBinary> {\n  const additionalSearchDirs = options.additionalSearchDirs ?? [];\n  const logPrefix = options.logPrefix ?? LOG_PREFIX;\n\n  const candidateNames = new Set<string>();\n  if (options.binaryPath) {\n    candidateNames.add(options.binaryPath);\n  }\n  if (CURSOR_BINARY_HINT) {\n    candidateNames.add(CURSOR_BINARY_HINT);\n  }\n  candidateNames.add(\"cursor-agent\");\n  if (process.platform === \"win32\") {\n    candidateNames.add(\"cursor-agent.exe\");\n  }\n\n  for (const name of candidateNames) {\n    if (!name) continue;\n    if (path.isAbsolute(name)) {\n      if (await pathExistsAndExecutable(name)) {\n        return {\n          binary: name,\n          env: null,\n        };\n      }\n      continue;\n    }\n\n    const whichCommand = process.platform === \"win32\" ? \"where\" : \"which\";\n    const lookup = spawnSync(whichCommand, [name], { encoding: \"utf8\" });\n    if (!lookup.error && lookup.status === 0 && lookup.stdout) {\n      const resolvedPath = lookup.stdout.split(/\\r?\\n/).find(Boolean);\n      if (resolvedPath && (await pathExistsAndExecutable(resolvedPath))) {\n        return {\n          binary: resolvedPath,\n          env: null,\n        };\n      }\n    }\n\n    for (const dir of buildCandidateDirs(name, additionalSearchDirs)) {\n      const fullPath = path.join(dir, name);\n      if (await pathExistsAndExecutable(fullPath)) {\n        return {\n          binary: fullPath,\n          env: null,\n        };\n      }\n    }\n  }\n\n  console.error(\n    `${logPrefix} cursor-agent binary not found. Set CURSOR_AGENT_BIN to an absolute path or add cursor-agent to your PATH.`,\n  );\n  throw new Error(\n    \"cursor-agent binary not found. Set CURSOR_AGENT_BIN to an absolute path or add cursor-agent to your PATH.\",\n  );\n}\n\nexport async function resolveCursorAgentBinary(\n  options: ResolveOptions = {},\n): Promise<ResolvedBinary> {\n  if (options.binaryPath) {\n    const normalized = options.binaryPath.trim();\n    if (normalized && (await pathExistsAndExecutable(normalized))) {\n      return {\n        binary: normalized,\n        env: null,\n      };\n    }\n  }\n\n  if (cachedBinary) {\n    return {\n      binary: cachedBinary,\n      env: cachedEnv,\n    };\n  }\n\n  if (!resolvePromise) {\n    resolvePromise = discoverCursorAgentBinary(options)\n      .then((resolved) => {\n        cachedBinary = resolved.binary;\n        const extraDirs: string[] = [\n          ...(options.additionalSearchDirs ?? []),\n          path.dirname(resolved.binary),\n        ];\n        if (HOME_DIR) {\n          extraDirs.push(path.join(HOME_DIR, \".cursor\", \"bin\"));\n          extraDirs.push(path.join(HOME_DIR, \"Library\", \"Application Support\", \"Cursor\", \"bin\"));\n          extraDirs.push(path.join(HOME_DIR, \"AppData\", \"Local\", \"Programs\", \"cursor\", \"bin\"));\n        }\n\n        const existingPath = process.env.PATH ?? \"\";\n        const pathSegments = new Set<string>(\n          existingPath\n            .split(path.delimiter)\n            .map((segment) => segment.trim())\n            .filter(Boolean),\n        );\n\n        for (const dir of extraDirs) {\n          if (dir) {\n            pathSegments.add(dir);\n          }\n        }\n\n        cachedEnv = {\n          ...process.env,\n          PATH: Array.from(pathSegments).join(path.delimiter),\n        };\n\n        return {\n          binary: resolved.binary,\n          env: cachedEnv,\n        };\n      })\n      .catch((error) => {\n        resolvePromise = null;\n        throw error;\n      });\n  }\n\n  return resolvePromise;\n}\n\nexport async function runCursorAgentStream(\n  options: RunOptions,\n  send: (event: StreamEvent) => void,\n) {\n  const logPrefix = options.logPrefix ?? LOG_PREFIX;\n  await new Promise<void>((resolve) => {\n    try {\n      const args = [\n        \"--print\",\n        \"--force\",\n        \"--output-format\",\n        \"stream-json\",\n        \"--stream-partial-output\",\n        \"--model\",\n        options.model,\n        options.prompt,\n      ];\n\n      console.log(`${logPrefix} Spawning cursor-agent`, {\n        command: options.binary,\n        args,\n        cwd: process.cwd(),\n      });\n\n      const child = spawn(options.binary, args, {\n        cwd: process.cwd(),\n        env: options.env ?? process.env,\n        stdio: [\"ignore\", \"pipe\", \"pipe\"],\n      });\n\n      let stdoutBuffer = \"\";\n      let stderrAggregate = \"\";\n      let assistantSummary = \"\";\n      let settled = false;\n\n      const timeoutMs =\n        typeof options.timeoutMs === \"number\"\n          ? options.timeoutMs\n          : Number(process.env.SHIPFLOW_OVERLAY_AGENT_TIMEOUT_MS ?? 4 * 60 * 1000);\n\n      const sendStatus = (message: string) => {\n        if (!message) return;\n        send({ event: \"status\", message });\n      };\n\n      const appendAssistant = (text: string) => {\n        if (!text) return;\n        assistantSummary += text;\n        send({ event: \"assistant\", text });\n      };\n\n      const flushDone = (success: boolean, exitCode: number | null, error?: string) => {\n        send({\n          event: \"done\",\n          success,\n          summary: assistantSummary.trim(),\n          exitCode,\n          error,\n          stderr: stderrAggregate.trim() || undefined,\n        });\n      };\n\n      const processLine = (line: string) => {\n        if (!line.trim()) {\n          return;\n        }\n\n        try {\n          const parsed = JSON.parse(line) as Record<string, unknown>;\n          const status = describeEvent(parsed);\n          if (status) {\n            const trimmed = status.trim();\n            const isWhitelisted = WHITELISTED_STATUS_MESSAGES.has(trimmed);\n            const isIgnored = IGNORED_STATUS_MESSAGES.has(trimmed);\n            const isLongEnough = trimmed.length >= MIN_STATUS_LENGTH;\n\n            if (!isIgnored && (isWhitelisted || isLongEnough)) {\n              sendStatus(trimmed);\n            }\n          }\n\n          if (typeof parsed.type === \"string\" && parsed.type === \"assistant\") {\n            const text = extractAssistantText(parsed);\n            appendAssistant(text);\n          }\n\n          if (typeof parsed.type === \"string\" && parsed.type === \"result\") {\n            const text = extractAssistantText(parsed);\n            appendAssistant(text);\n          }\n        } catch (error) {\n          console.warn(`${logPrefix} Failed to parse cursor-agent stream line`, {\n            line,\n            error,\n          });\n          sendStatus(line);\n        }\n      };\n\n      const timeoutId = setTimeout(() => {\n        if (settled) return;\n        settled = true;\n\n        console.warn(`${logPrefix} cursor-agent exceeded timeout; terminating process`, {\n          timeoutMs,\n        });\n\n        sendStatus(`Cursor CLI timed out after ${timeoutMs}ms; terminating process.`);\n\n        try {\n          child.kill(\"SIGTERM\");\n        } catch (killError) {\n          console.warn(`${logPrefix} Failed to terminate cursor-agent process`, killError);\n        }\n\n        flushDone(false, null, `Cursor CLI timed out after ${timeoutMs}ms.`);\n        resolve();\n      }, timeoutMs);\n\n      child.stdout.on(\"data\", (chunk) => {\n        const text = chunk.toString();\n        stdoutBuffer += text;\n\n        let newlineIndex = stdoutBuffer.indexOf(\"\\n\");\n        while (newlineIndex !== -1) {\n          const line = stdoutBuffer.slice(0, newlineIndex);\n          stdoutBuffer = stdoutBuffer.slice(newlineIndex + 1);\n          processLine(line);\n          newlineIndex = stdoutBuffer.indexOf(\"\\n\");\n        }\n      });\n\n      child.stderr.on(\"data\", (chunk) => {\n        const text = chunk.toString();\n        stderrAggregate += text;\n        for (const line of text.split(/\\r?\\n/).map((entry: string) => entry.trim()).filter(Boolean)) {\n          sendStatus(`[stderr] ${line}`);\n        }\n        console.error(`${logPrefix} cursor-agent stderr:`, text);\n      });\n\n      child.on(\"error\", (error) => {\n        if (settled) return;\n        settled = true;\n        clearTimeout(timeoutId);\n        console.error(`${logPrefix} cursor-agent failed to start`, error);\n        flushDone(false, null, error instanceof Error ? error.message : \"Failed to start Cursor CLI.\");\n        resolve();\n      });\n\n      child.on(\"close\", (exitCode) => {\n        if (settled) return;\n        settled = true;\n        clearTimeout(timeoutId);\n\n        if (stdoutBuffer.trim()) {\n          processLine(stdoutBuffer);\n          stdoutBuffer = \"\";\n        }\n\n        console.log(`${logPrefix} cursor-agent exited`, { exitCode });\n\n        if (exitCode === 0) {\n          flushDone(true, exitCode ?? 0);\n        } else {\n          const error =\n            stderrAggregate.trim() ||\n            `Cursor CLI exited with status ${exitCode ?? \"unknown\"}. Check server logs for details.`;\n          flushDone(false, exitCode ?? null, error);\n        }\n\n        resolve();\n      });\n    } catch (error) {\n      console.error(`${logPrefix} Unexpected error launching cursor-agent`, error);\n      send({\n        event: \"done\",\n        success: false,\n        summary: \"\",\n        exitCode: null,\n        error: error instanceof Error ? error.message : \"Unexpected error launching Cursor CLI.\",\n      });\n      resolve();\n    }\n  });\n}\n\n\n\n"],"mappings":"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","names":["_a","_a","_b"]}